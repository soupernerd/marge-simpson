#!/usr/bin/env bash
set -euo pipefail

# marge-init
# Initialize .marge/ in the current project directory.
#
# Creates a hybrid setup with:
#   - Symlinks to global shared resources (AGENTS.md, experts, workflows, etc.)
#   - Local per-project files (tracking/assessment.md, tracking/tasklist.md)
#
# Usage: marge-init [OPTIONS]
#
# Options:
#   -f, --force       Overwrite existing .marge/ folder
#   -n, --no-gitignore  Don't add .marge/ to .gitignore
#   -h, --help        Show this help message

MARGE_HOME="${MARGE_HOME:-$HOME/.marge}"
TARGET_DIR="./.marge"
FORCE=0
UPDATE_GITIGNORE=1

print_usage() {
    sed -n '3,14p' "$0" | sed 's/^# //' | sed 's/^#//'
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        -f|--force)
            FORCE=1
            shift
            ;;
        -n|--no-gitignore)
            UPDATE_GITIGNORE=0
            shift
            ;;
        -h|--help)
            print_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            print_usage
            exit 1
            ;;
    esac
done

# Validate global installation
if [[ ! -d "$MARGE_HOME/shared" ]]; then
    echo "Error: Global marge installation not found at $MARGE_HOME" >&2
    echo "" >&2
    echo "Install marge globally first:" >&2
    echo "  ./install-global.sh" >&2
    echo "" >&2
    echo "Or set MARGE_HOME to your installation directory:" >&2
    echo "  export MARGE_HOME=/path/to/marge" >&2
    exit 1
fi

if [[ -e "$TARGET_DIR" ]]; then
    if [[ "$FORCE" -ne 1 ]]; then
        echo "Error: $TARGET_DIR already exists." >&2
        echo "Use --force to overwrite, or remove it manually." >&2
        exit 1
    fi
    echo "Removing existing $TARGET_DIR..."
    rm -rf "$TARGET_DIR"
fi

echo "Initializing .marge/..."

# Create directory structure
mkdir -p "$TARGET_DIR"

# Symlink shared resources (with fallback to copy if symlinks fail)
# Note: model_pricing.json is copied from system/ by install-global
SHARED_LINKS=(
    "AGENTS.md"
    "AGENTS-lite.md"
    "experts"
    "knowledge"
    "model_pricing.json"
    "prompts"
    "README.md"
    "scripts"
    "VERSION"
    "workflows"
)

SYMLINK_FAILED=0
for item in "${SHARED_LINKS[@]}"; do
    if [[ -e "$MARGE_HOME/shared/$item" ]]; then
        if ! ln -s "$MARGE_HOME/shared/$item" "$TARGET_DIR/$item" 2>/dev/null; then
            # Fall back to copying if symlinks fail
            if [[ "$SYMLINK_FAILED" -eq 0 ]]; then
                echo "Warning: Symlinks not supported. Falling back to copies." >&2
                echo "         You'll need to run 'marge-init --force' after updates to refresh files." >&2
                SYMLINK_FAILED=1
            fi
            cp -R "$MARGE_HOME/shared/$item" "$TARGET_DIR/$item"
        fi
    fi
done

# Create tracking directory and copy per-project templates
TRACKING_DIR="$TARGET_DIR/tracking"
mkdir -p "$TRACKING_DIR"

TEMPLATE_FILES=(
    "assessment.md"
    "tasklist.md"
    "PRD.md"
)

for item in "${TEMPLATE_FILES[@]}"; do
    if [[ -e "$MARGE_HOME/templates/$item" ]]; then
        cp "$MARGE_HOME/templates/$item" "$TRACKING_DIR/"
    fi
done

# Copy verify.config.json to root
if [[ -e "$MARGE_HOME/templates/verify.config.json" ]]; then
    cp "$MARGE_HOME/templates/verify.config.json" "$TARGET_DIR/"
fi

# Update .gitignore
if [[ "$UPDATE_GITIGNORE" -eq 1 ]]; then
    if [[ -f ".gitignore" ]]; then
        if ! grep -q "^\.marge/$" .gitignore 2>/dev/null; then
            {
                echo ""
                echo "# Marge workflow folder (local tooling)"
                echo ".marge/"
            } >> .gitignore
            echo "Added .marge/ to .gitignore"
        fi
    else
        {
            echo "# Marge workflow folder (local tooling)"
            echo ".marge/"
        } > .gitignore
        echo "Created .gitignore with .marge/"
    fi
fi

echo ""
echo "âœ“ .marge/ initialized"
echo ""
if [[ "$SYMLINK_FAILED" -eq 1 ]]; then
    echo "Structure (copies - symlinks unavailable):"
    LINK_TYPE="(copy)"
else
    echo "Structure:"
    LINK_TYPE="(symlink)"
fi
echo "  .marge/"
echo "  +-- AGENTS.md           -> \$MARGE_HOME/shared/ $LINK_TYPE"
echo "  +-- experts/            -> \$MARGE_HOME/shared/ $LINK_TYPE"
echo "  +-- workflows/          -> \$MARGE_HOME/shared/ $LINK_TYPE"
echo "  +-- scripts/            -> \$MARGE_HOME/shared/ $LINK_TYPE"
echo "  +-- knowledge/          -> \$MARGE_HOME/shared/ $LINK_TYPE"
echo "  +-- tracking/"
echo "  |   +-- assessment.md   (local - per-project)"
echo "  |   +-- tasklist.md     (local - per-project)"
echo "  |   +-- PRD.md          (local - per-project)"
echo "  +-- verify.config.json  (local - per-project)"
echo ""
echo "Edit verify.config.json to configure your project's test commands."
echo ""
echo "Ready to use marge!"
echo ""
echo "Quick start:"
echo "  marge \"describe your first task\""
echo ""
echo "For help:"
echo "  marge --help"
