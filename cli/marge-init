#!/usr/bin/env bash
set -euo pipefail

# marge-init
# Initialize .marge/ in the current project directory.
#
# Creates a hybrid setup with:
#   - Symlinks to global shared resources (AGENTS.md, experts, workflows, etc.)
#   - Local per-project files (assessment.md, tasklist.md, verify_logs/)
#
# Usage: marge-init [OPTIONS]
#
# Options:
#   -f, --force       Overwrite existing .marge/ folder
#   -n, --no-gitignore  Don't add .marge/ to .gitignore
#   -h, --help        Show this help message

MARGE_HOME="${MARGE_HOME:-$HOME/.marge}"
TARGET_DIR="./.marge"
FORCE=0
UPDATE_GITIGNORE=1

print_usage() {
    sed -n '3,14p' "$0" | sed 's/^# //' | sed 's/^#//'
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        -f|--force)
            FORCE=1
            shift
            ;;
        -n|--no-gitignore)
            UPDATE_GITIGNORE=0
            shift
            ;;
        -h|--help)
            print_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            print_usage
            exit 1
            ;;
    esac
done

# Validate global installation
if [[ ! -d "$MARGE_HOME/shared" ]]; then
    echo "Error: Global marge installation not found at $MARGE_HOME" >&2
    echo "" >&2
    echo "Install marge globally first:" >&2
    echo "  ./install-global.sh" >&2
    echo "" >&2
    echo "Or set MARGE_HOME to your installation directory:" >&2
    echo "  export MARGE_HOME=/path/to/marge" >&2
    exit 1
fi

if [[ -e "$TARGET_DIR" ]]; then
    if [[ "$FORCE" -ne 1 ]]; then
        echo "Error: $TARGET_DIR already exists." >&2
        echo "Use --force to overwrite, or remove it manually." >&2
        exit 1
    fi
    echo "Removing existing $TARGET_DIR..."
    rm -rf "$TARGET_DIR"
fi

echo "Initializing .marge/..."

# Create directory structure
mkdir -p "$TARGET_DIR/verify_logs"

# Symlink shared resources
SHARED_LINKS=(
    "AGENTS.md"
    "assets"
    "experts"
    "knowledge"
    "model_pricing.json"
    "plans"
    "prompt_examples"
    "README.md"
    "scripts"
    "VERSION"
    "workflows"
)

for item in "${SHARED_LINKS[@]}"; do
    if [[ -e "$MARGE_HOME/shared/$item" ]]; then
        ln -s "$MARGE_HOME/shared/$item" "$TARGET_DIR/$item"
    fi
done

# Copy per-project templates
TEMPLATE_FILES=(
    "assessment.md"
    "instructions_log.md"
    "tasklist.md"
    "verify.config.json"
)

for item in "${TEMPLATE_FILES[@]}"; do
    if [[ -e "$MARGE_HOME/templates/$item" ]]; then
        cp "$MARGE_HOME/templates/$item" "$TARGET_DIR/"
    fi
done

# Update .gitignore
if [[ "$UPDATE_GITIGNORE" -eq 1 ]]; then
    if [[ -f ".gitignore" ]]; then
        if ! grep -q "^\.marge/$" .gitignore 2>/dev/null; then
            {
                echo ""
                echo "# Marge workflow folder (local tooling)"
                echo ".marge/"
            } >> .gitignore
            echo "Added .marge/ to .gitignore"
        fi
    else
        {
            echo "# Marge workflow folder (local tooling)"
            echo ".marge/"
        } > .gitignore
        echo "Created .gitignore with .marge/"
    fi
fi

echo ""
echo "✓ .marge/ initialized"
echo ""
echo "Structure:"
echo "  .marge/"
echo "  ├── AGENTS.md           → $MARGE_HOME/shared/ (symlink)"
echo "  ├── experts/            → $MARGE_HOME/shared/ (symlink)"
echo "  ├── workflows/          → $MARGE_HOME/shared/ (symlink)"
echo "  ├── scripts/            → $MARGE_HOME/shared/ (symlink)"
echo "  ├── knowledge/          → $MARGE_HOME/shared/ (symlink)"
echo "  ├── assessment.md       (local - per-project)"
echo "  ├── tasklist.md         (local - per-project)"
echo "  ├── verify.config.json  (local - per-project)"
echo "  ├── instructions_log.md (local - per-project)"
echo "  └── verify_logs/        (local - per-project)"
echo ""
echo "Edit verify.config.json to configure your project's test commands."
echo ""
echo "Ready to use marge! Start with:"
echo "  - Read .marge/AGENTS.md for workflow rules"
echo "  - Add tasks to .marge/tasklist.md"
echo "  - Run verification: ./.marge/scripts/verify.sh fast"
