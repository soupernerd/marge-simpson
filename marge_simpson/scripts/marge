#!/usr/bin/env bash
# marge - CLI wrapper for Marge Simpson Mode
# Usage: marge [command] [args...]
#
# Commands:
#   fix <description>    Create a bug fix task
#   add <description>    Create a feature task
#   audit                Run a codebase audit
#   status               Show current task status
#   verify [fast|full]   Run verification
#   init                 Initialize marge_simpson folder in current project
#   help                 Show this help message
#
# Examples:
#   marge fix "the login button is broken"
#   marge add "dark mode support"
#   marge audit
#   marge verify fast

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MARGE_HOME="${MARGE_HOME:-$HOME/.marge}"
SHARED_DIR="$MARGE_HOME/shared"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_banner() {
    echo -e "${BLUE}"
    echo "  __  __    _    ____   ____ _____ "
    echo " |  \/  |  / \  |  _ \ / ___| ____|"
    echo " | |\/| | / _ \ | |_) | |  _|  _|  "
    echo " | |  | |/ ___ \|  _ <| |_| | |___ "
    echo " |_|  |_/_/   \_\_| \_\\\\____|_____|"
    echo -e "${NC}"
}

show_help() {
    print_banner
    echo "Usage: marge [command] [args...]"
    echo ""
    echo "Commands:"
    echo "  fix <description>    Create a bug fix task"
    echo "  add <description>    Create a feature task  "
    echo "  audit                Run a codebase audit"
    echo "  status               Show current task status"
    echo "  verify [fast|full]   Run verification (default: fast)"
    echo "  init                 Initialize marge_simpson folder"
    echo "  help                 Show this help message"
    echo ""
    echo "Examples:"
    echo "  marge fix \"the login button is broken\""
    echo "  marge add \"dark mode support\""
    echo "  marge audit"
    echo "  marge verify fast"
    echo ""
    echo "Environment:"
    echo "  MARGE_HOME           Marge installation directory (default: ~/.marge)"
}

find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/marge_simpson" ]]; then
            echo "$dir"
            return 0
        fi
        if [[ -d "$dir/.git" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    echo "$PWD"
}

check_marge_folder() {
    local project_root="$1"
    if [[ ! -d "$project_root/marge_simpson" ]]; then
        echo -e "${YELLOW}Warning: marge_simpson folder not found in project.${NC}"
        echo -e "Run ${GREEN}marge init${NC} to set up Marge in this project."
        return 1
    fi
    return 0
}

cmd_init() {
    local project_root="$(find_project_root)"
    local marge_dir="$project_root/marge_simpson"

    if [[ -d "$marge_dir" ]]; then
        echo -e "${YELLOW}marge_simpson folder already exists at $marge_dir${NC}"
        return 1
    fi

    echo -e "${BLUE}Initializing Marge in $project_root...${NC}"

    # Create marge_simpson directory
    mkdir -p "$marge_dir"
    mkdir -p "$marge_dir/verify_logs"

    # Create symlinks to shared resources
    ln -sf "$SHARED_DIR/AGENTS.md" "$marge_dir/AGENTS.md"
    ln -sf "$SHARED_DIR/README.md" "$marge_dir/README.md"
    ln -sf "$SHARED_DIR/VERSION" "$marge_dir/VERSION"
    ln -sf "$SHARED_DIR/assets" "$marge_dir/assets"
    ln -sf "$SHARED_DIR/experts" "$marge_dir/experts"
    ln -sf "$SHARED_DIR/knowledge" "$marge_dir/knowledge"
    ln -sf "$SHARED_DIR/model_pricing.json" "$marge_dir/model_pricing.json"
    ln -sf "$SHARED_DIR/prompt_examples" "$marge_dir/prompt_examples"
    ln -sf "$SHARED_DIR/scripts" "$marge_dir/scripts"
    ln -sf "$SHARED_DIR/workflows" "$marge_dir/workflows"

    # Create local tracking files
    cat > "$marge_dir/assessment.md" << 'EOF'
# Assessment

> Point-in-time snapshot of repository status and findings.

**Next ID:** MS-0001

## Current Snapshot

| Field | Value |
|-------|-------|
| Last Audit | Never |
| Open Issues | 0 |
| In Progress | 0 |

## Known Invariants

(Add project-specific rules here)

## Findings by Area

### Critical (P0)
(None)

### Important (P1)
(None)

### Nice-to-Have (P2)
(None)

---

## Issues Log

(Issues will be logged here with MS-#### IDs)
EOF

    cat > "$marge_dir/tasklist.md" << 'EOF'
# Task List

> Single source of truth for active work.

**Next ID:** MS-0001

## Work Queue

### P0 - Breaking / Blocking
(None)

### P1 - Important
(None)

### P2 - Nice-to-Have
(None)

---

## In Progress
(None)

---

## Done
(None)
EOF

    cat > "$marge_dir/instructions_log.md" << 'EOF'
# Instructions Log

> Append-only log of user instructions. Never edit, only append.

---
EOF

    cat > "$marge_dir/verify.config.json" << 'EOF'
{
  "fast": [],
  "full": []
}
EOF

    echo -e "${GREEN}Marge initialized successfully!${NC}"
    echo ""
    echo "Created:"
    echo "  - $marge_dir/assessment.md"
    echo "  - $marge_dir/tasklist.md"
    echo "  - $marge_dir/instructions_log.md"
    echo "  - $marge_dir/verify.config.json"
    echo ""
    echo -e "Add ${YELLOW}marge_simpson/${NC} to your .gitignore (tracking files are internal)."
    echo -e "Tell your AI: ${GREEN}\"Use the marge_simpson folder for audits and fixes.\"${NC}"
}

cmd_fix() {
    local description="$*"
    if [[ -z "$description" ]]; then
        echo -e "${RED}Error: Please provide a bug description${NC}"
        echo "Usage: marge fix <description>"
        return 1
    fi

    print_banner
    echo -e "${GREEN}Bug Report:${NC} $description"
    echo ""
    echo "Instruction for AI assistant:"
    echo "---"
    echo "Use the marge_simpson folder. Fix this bug: $description"
    echo "Follow AGENTS.md workflow. Create MS-#### tracking ID."
    echo "---"
}

cmd_add() {
    local description="$*"
    if [[ -z "$description" ]]; then
        echo -e "${RED}Error: Please provide a feature description${NC}"
        echo "Usage: marge add <description>"
        return 1
    fi

    print_banner
    echo -e "${GREEN}Feature Request:${NC} $description"
    echo ""
    echo "Instruction for AI assistant:"
    echo "---"
    echo "Use the marge_simpson folder. Add this feature: $description"
    echo "Follow AGENTS.md workflow. Create MS-#### tracking ID."
    echo "---"
}

cmd_audit() {
    print_banner
    echo -e "${GREEN}Audit Request${NC}"
    echo ""
    echo "Instruction for AI assistant:"
    echo "---"
    echo "Use the marge_simpson folder. Run a full codebase audit."
    echo "Follow workflows/audit.md process. Create MS-#### for each finding."
    echo "---"
}

cmd_status() {
    local project_root="$(find_project_root)"

    if ! check_marge_folder "$project_root"; then
        return 1
    fi

    print_banner

    if [[ -x "$project_root/marge_simpson/scripts/status.sh" ]]; then
        "$project_root/marge_simpson/scripts/status.sh"
    elif [[ -f "$project_root/marge_simpson/tasklist.md" ]]; then
        echo -e "${BLUE}=== Task List ===${NC}"
        head -50 "$project_root/marge_simpson/tasklist.md"
    else
        echo -e "${YELLOW}No status information available${NC}"
    fi
}

cmd_verify() {
    local mode="${1:-fast}"
    local project_root="$(find_project_root)"

    if ! check_marge_folder "$project_root"; then
        return 1
    fi

    print_banner
    echo -e "${BLUE}Running verification (mode: $mode)...${NC}"

    if [[ -x "$project_root/marge_simpson/scripts/verify.sh" ]]; then
        "$project_root/marge_simpson/scripts/verify.sh" "$mode"
    else
        echo -e "${YELLOW}verify.sh not found or not executable${NC}"
        return 1
    fi
}

# Main command router
case "${1:-help}" in
    fix)
        shift
        cmd_fix "$@"
        ;;
    add)
        shift
        cmd_add "$@"
        ;;
    audit)
        cmd_audit
        ;;
    status)
        cmd_status
        ;;
    verify)
        shift
        cmd_verify "$@"
        ;;
    init)
        cmd_init
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'marge help' for usage information."
        exit 1
        ;;
esac
