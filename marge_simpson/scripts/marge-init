#!/usr/bin/env bash
# marge-init - Initialize Marge Simpson Mode in a project
#
# This script sets up the marge_simpson folder with all necessary
# symlinks and tracking files for a new project.
#
# Usage: marge-init [project-path]
#
# If no path is provided, initializes in the current directory.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MARGE_HOME="${MARGE_HOME:-$HOME/.marge}"
SHARED_DIR="$MARGE_HOME/shared"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_banner() {
    echo -e "${BLUE}"
    echo "  __  __    _    ____   ____ _____   ___ _   _ ___ _____ "
    echo " |  \/  |  / \  |  _ \ / ___| ____| |_ _| \ | |_ _|_   _|"
    echo " | |\/| | / _ \ | |_) | |  _|  _|    | ||  \| || |  | |  "
    echo " | |  | |/ ___ \|  _ <| |_| | |___   | || |\  || |  | |  "
    echo " |_|  |_/_/   \_\_| \_\\\\____|_____| |___|_| \_|___| |_|  "
    echo -e "${NC}"
}

# Determine project root
PROJECT_ROOT="${1:-$(pwd)}"
PROJECT_ROOT="$(cd "$PROJECT_ROOT" && pwd)"
MARGE_DIR="$PROJECT_ROOT/marge_simpson"

print_banner

echo -e "${BLUE}Initializing Marge Simpson Mode${NC}"
echo "Project: $PROJECT_ROOT"
echo ""

# Check if shared directory exists
if [[ ! -d "$SHARED_DIR" ]]; then
    echo -e "${RED}Error: Marge shared directory not found at $SHARED_DIR${NC}"
    echo "Please ensure Marge is properly installed."
    echo ""
    echo "Expected location: $MARGE_HOME/shared"
    exit 1
fi

# Check if already initialized
if [[ -d "$MARGE_DIR" ]]; then
    echo -e "${YELLOW}Warning: marge_simpson folder already exists.${NC}"
    read -p "Reinitialize? This will overwrite tracking files. (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Create marge_simpson directory
echo -e "${BLUE}Creating directory structure...${NC}"
mkdir -p "$MARGE_DIR"
mkdir -p "$MARGE_DIR/verify_logs"

# Create symlinks to shared resources
echo -e "${BLUE}Creating symlinks to shared resources...${NC}"

create_symlink() {
    local target="$1"
    local link="$2"

    # Remove existing link/file if it exists
    rm -rf "$link" 2>/dev/null || true

    if ln -sf "$target" "$link" 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} $(basename "$link")"
    else
        echo -e "  ${YELLOW}!${NC} $(basename "$link") (copying instead)"
        cp -r "$target" "$link"
    fi
}

create_symlink "$SHARED_DIR/AGENTS.md" "$MARGE_DIR/AGENTS.md"
create_symlink "$SHARED_DIR/README.md" "$MARGE_DIR/README.md"
create_symlink "$SHARED_DIR/VERSION" "$MARGE_DIR/VERSION"
create_symlink "$SHARED_DIR/assets" "$MARGE_DIR/assets"
create_symlink "$SHARED_DIR/experts" "$MARGE_DIR/experts"
create_symlink "$SHARED_DIR/knowledge" "$MARGE_DIR/knowledge"
create_symlink "$SHARED_DIR/model_pricing.json" "$MARGE_DIR/model_pricing.json"
create_symlink "$SHARED_DIR/prompt_examples" "$MARGE_DIR/prompt_examples"
create_symlink "$SHARED_DIR/scripts" "$MARGE_DIR/scripts"
create_symlink "$SHARED_DIR/workflows" "$MARGE_DIR/workflows"

# Create local tracking files
echo -e "${BLUE}Creating tracking files...${NC}"

cat > "$MARGE_DIR/assessment.md" << 'EOF'
# Assessment

> Point-in-time snapshot of repository status and findings.

**Next ID:** MS-0001

## Current Snapshot

| Field | Value |
|-------|-------|
| Last Audit | Never |
| Open Issues | 0 |
| In Progress | 0 |

## Known Invariants

(Add project-specific rules here)

## Findings by Area

### Critical (P0)
(None)

### Important (P1)
(None)

### Nice-to-Have (P2)
(None)

---

## Issues Log

(Issues will be logged here with MS-#### IDs)
EOF
echo -e "  ${GREEN}✓${NC} assessment.md"

cat > "$MARGE_DIR/tasklist.md" << 'EOF'
# Task List

> Single source of truth for active work.

**Next ID:** MS-0001

## Work Queue

### P0 - Breaking / Blocking
(None)

### P1 - Important
(None)

### P2 - Nice-to-Have
(None)

---

## In Progress
(None)

---

## Done
(None)
EOF
echo -e "  ${GREEN}✓${NC} tasklist.md"

cat > "$MARGE_DIR/instructions_log.md" << 'EOF'
# Instructions Log

> Append-only log of user instructions. Never edit, only append.

---
EOF
echo -e "  ${GREEN}✓${NC} instructions_log.md"

cat > "$MARGE_DIR/verify.config.json" << 'EOF'
{
  "fast": [],
  "full": []
}
EOF
echo -e "  ${GREEN}✓${NC} verify.config.json"

# Check .gitignore
echo ""
if [[ -f "$PROJECT_ROOT/.gitignore" ]]; then
    if grep -q "marge_simpson" "$PROJECT_ROOT/.gitignore"; then
        echo -e "${GREEN}✓${NC} marge_simpson already in .gitignore"
    else
        echo -e "${YELLOW}!${NC} Consider adding marge_simpson/ to .gitignore"
    fi
else
    echo -e "${YELLOW}!${NC} No .gitignore found. Consider creating one with marge_simpson/"
fi

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  Marge Simpson Mode initialized successfully!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "Next steps:"
echo "  1. Add 'marge_simpson/' to your .gitignore"
echo "  2. Configure verify.config.json with your test commands"
echo "  3. Tell your AI: \"Use the marge_simpson folder for audits and fixes.\""
echo ""
